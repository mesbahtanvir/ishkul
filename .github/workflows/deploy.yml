name: Deploy to Firebase & Cloud Run

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1

jobs:
  deploy-backend:
    name: Deploy Backend to Cloud Run
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Project ID
        run: |
          # Verify GCP_PROJECT_ID is not empty or whitespace
          if [ -z "$(echo "${{ env.GCP_PROJECT_ID }}" | tr -d '[:space:]')" ]; then
            echo "âŒ ERROR: GCP_PROJECT_ID secret is empty or contains only whitespace"
            exit 1
          fi
          echo "âœ… GCP_PROJECT_ID is set"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Verify and enable required APIs
        run: |
          echo "ðŸ”§ Verifying required APIs are enabled..."

          GCP_PROJECT_ID="${{ env.GCP_PROJECT_ID }}"

          # List of APIs required for Cloud Run source-based deployment
          REQUIRED_APIS=(
            "cloudbuild.googleapis.com"
            "run.googleapis.com"
            "artifactregistry.googleapis.com"
          )

          MISSING_APIS=()

          for api in "${REQUIRED_APIS[@]}"; do
            echo "Checking $api..."
            if gcloud services list --enabled --filter="name:$api" --project=$GCP_PROJECT_ID --format="value(name)" 2>/dev/null | grep -q "$api"; then
              echo "  âœ… $api is enabled"
            else
              echo "  â³ Attempting to enable $api..."
              if gcloud services enable "$api" --project=$GCP_PROJECT_ID 2>&1; then
                echo "  âœ… $api enabled successfully"
              else
                echo "  âŒ $api is NOT enabled and could not be enabled"
                MISSING_APIS+=("$api")
              fi
            fi
          done

          if [ ${#MISSING_APIS[@]} -gt 0 ]; then
            echo ""
            echo "âŒ ERROR: The following APIs are not enabled and the service account lacks permission to enable them:"
            for api in "${MISSING_APIS[@]}"; do
              echo "  - $api"
            done
            echo ""
            echo "Please enable these APIs manually by running the following commands with an account that has Owner/Editor access:"
            echo ""
            for api in "${MISSING_APIS[@]}"; do
              echo "  gcloud services enable $api --project=$GCP_PROJECT_ID"
            done
            echo ""
            echo "Or enable them via the Google Cloud Console:"
            echo "  https://console.cloud.google.com/apis/library?project=$GCP_PROJECT_ID"
            echo ""
            exit 1
          fi

          echo ""
          echo "âœ… All required APIs are enabled"

      - name: Deploy to Cloud Run (source-based)
        run: |
          set -e
          GCP_PROJECT_ID="${{ env.GCP_PROJECT_ID }}"

          # Create environment variables YAML file
          # Using YAML format to handle special characters properly
          cat > /tmp/env-vars.yaml << EOF
          FIREBASE_STORAGE_BUCKET: $GCP_PROJECT_ID.appspot.com
          ALLOWED_ORIGINS: https://$GCP_PROJECT_ID.web.app,https://$GCP_PROJECT_ID.firebaseapp.com
          EOF

          # Use source-based deployment - Cloud Build handles the container build
          # Check if secret exists
          if gcloud secrets describe firebase-service-account --project=$GCP_PROJECT_ID &>/dev/null; then
            echo "Deploying with Secret Manager..."
            gcloud run deploy ishkul-backend \
              --source ./backend \
              --build-config cloudbuild.yaml \
              --platform managed \
              --region ${{ env.REGION }} \
              --allow-unauthenticated \
              --env-vars-file /tmp/env-vars.yaml \
              --set-secrets "GOOGLE_APPLICATION_CREDENTIALS=/secrets/firebase-credentials:firebase-service-account:latest" \
              --project $GCP_PROJECT_ID \
              --quiet
          else
            echo "Deploying without Secret Manager (using default service account)..."
            gcloud run deploy ishkul-backend \
              --source ./backend \
              --build-config cloudbuild.yaml \
              --platform managed \
              --region ${{ env.REGION }} \
              --allow-unauthenticated \
              --env-vars-file /tmp/env-vars.yaml \
              --project $GCP_PROJECT_ID \
              --quiet
          fi

          # Clean up
          rm -f /tmp/env-vars.yaml

      - name: Get backend URL
        id: backend-url
        run: |
          set -e
          GCP_PROJECT_ID="${{ env.GCP_PROJECT_ID }}"
          URL=$(gcloud run services describe ishkul-backend \
            --region ${{ env.REGION }} \
            --format 'value(status.url)' \
            --project $GCP_PROJECT_ID)
          if [ -z "$URL" ]; then
            echo "âŒ Failed to retrieve backend URL"
            exit 1
          fi
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "âœ… Backend deployed to: $URL"

      - name: Verify backend health
        run: |
          set -e
          URL=${{ steps.backend-url.outputs.url }}
          echo "â³ Waiting for backend to be ready..."
          for i in {1..30}; do
            if curl -s -f "$URL/health" > /dev/null 2>&1 || curl -s -f "$URL/" > /dev/null 2>&1; then
              echo "âœ… Backend is healthy and responding"
              exit 0
            fi
            echo "  Attempt $i/30 - Waiting..."
            sleep 2
          done
          echo "âŒ Backend health check failed after 30 attempts"
          exit 1

    outputs:
      backend-url: ${{ steps.backend-url.outputs.url }}

  deploy-firestore:
    name: Deploy Firestore Rules & Indexes
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Project ID
        run: |
          # Verify GCP_PROJECT_ID is not empty or whitespace
          if [ -z "$(echo "${{ env.GCP_PROJECT_ID }}" | tr -d '[:space:]')" ]; then
            echo "âŒ ERROR: GCP_PROJECT_ID secret is empty or contains only whitespace"
            exit 1
          fi
          echo "âœ… GCP_PROJECT_ID is set"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Check Firebase config
        working-directory: firebase
        run: |
          echo "=== firebase.json ==="
          cat firebase.json
          echo ""
          echo "=== .firebaserc ==="
          cat .firebaserc
          echo ""
          echo "=== firestore.rules exists ==="
          ls -la firestore.rules
          echo ""
          echo "=== firestore.indexes.json exists ==="
          ls -la firestore.indexes.json

      - name: Deploy Firestore
        working-directory: firebase
        run: |
          GCP_PROJECT_ID="${{ env.GCP_PROJECT_ID }}"
          firebase deploy --only firestore --project=$GCP_PROJECT_ID --non-interactive

  deploy-storage:
    name: Deploy Storage Rules
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Project ID
        run: |
          # Verify GCP_PROJECT_ID is not empty or whitespace
          if [ -z "$(echo "${{ env.GCP_PROJECT_ID }}" | tr -d '[:space:]')" ]; then
            echo "âŒ ERROR: GCP_PROJECT_ID secret is empty or contains only whitespace"
            exit 1
          fi
          echo "âœ… GCP_PROJECT_ID is set"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Check Firebase config
        working-directory: firebase
        run: |
          echo "=== firebase.json ==="
          cat firebase.json
          echo ""
          echo "=== .firebaserc ==="
          cat .firebaserc
          echo ""
          echo "=== storage.rules exists ==="
          ls -la storage.rules

      - name: Verify Firebase authentication
        run: |
          GCP_PROJECT_ID="${{ env.GCP_PROJECT_ID }}"
          echo "=== Checking authentication ==="
          echo "GOOGLE_APPLICATION_CREDENTIALS: $GOOGLE_APPLICATION_CREDENTIALS"
          echo "Project ID: $GCP_PROJECT_ID"
          echo "Credentials file exists: $(ls -la $GOOGLE_APPLICATION_CREDENTIALS 2>/dev/null || echo 'NOT FOUND')"
          firebase projects:list 2>&1 | head -20 || echo "projects:list failed (may need specific permissions)"

      - name: Deploy Storage Rules
        working-directory: firebase
        run: |
          GCP_PROJECT_ID="${{ env.GCP_PROJECT_ID }}"
          echo "Deploying storage rules to project: $GCP_PROJECT_ID"
          # Use explicit project flag and ensure clean deployment
          firebase deploy --only storage --project="$GCP_PROJECT_ID" --non-interactive --debug 2>&1 | tee deploy-output.txt
          DEPLOY_EXIT_CODE=${PIPESTATUS[0]}
          if [ $DEPLOY_EXIT_CODE -ne 0 ]; then
            echo ""
            echo "=== Deploy failed with exit code $DEPLOY_EXIT_CODE ==="
            echo "=== Checking for common issues ==="
            echo ""
            # Check if Storage API is enabled
            gcloud services list --enabled --filter="name:firebasestorage.googleapis.com" --project="$GCP_PROJECT_ID" 2>/dev/null || echo "Could not check API status"
            exit $DEPLOY_EXIT_CODE
          fi
          echo "âœ… Storage rules deployed successfully"

  notify-deployment:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-firestore, deploy-storage]
    if: always()

    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend URL:** ${{ needs.deploy-backend.outputs.backend-url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Firestore:** Rules and indexes deployed" >> $GITHUB_STEP_SUMMARY
          echo "- **Storage:** Rules deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
