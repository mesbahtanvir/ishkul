name: Deploy Firebase Rules

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  check-environment:
    name: Check Production Environment
    runs-on: ubuntu-latest
    environment: production

  deploy-firestore:
    name: Deploy Firestore Rules & Indexes
    runs-on: ubuntu-latest
    needs: check-environment

    permissions:
      contents: read

    env:
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      REGION: us-central1

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Project ID
        run: |
          # Verify GCP_PROJECT_ID is not empty or whitespace
          if [ -z "$(echo "${{ env.GCP_PROJECT_ID }}" | tr -d '[:space:]')" ]; then
            echo "âŒ ERROR: GCP_PROJECT_ID secret is empty or contains only whitespace"
            exit 1
          fi
          echo "âœ… GCP_PROJECT_ID is set"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Check Firebase config
        working-directory: firebase
        run: |
          echo "=== firebase.json ==="
          cat firebase.json
          echo ""
          echo "=== .firebaserc ==="
          cat .firebaserc
          echo ""
          echo "=== firestore.rules exists ==="
          ls -la firestore.rules
          echo ""
          echo "=== firestore.indexes.json exists ==="
          ls -la firestore.indexes.json

      - name: Deploy Firestore
        working-directory: firebase
        run: |
          GCP_PROJECT_ID="${{ env.GCP_PROJECT_ID }}"
          firebase deploy --only firestore --project=$GCP_PROJECT_ID --non-interactive

  deploy-storage:
    name: Deploy Storage Rules
    runs-on: ubuntu-latest
    needs: check-environment

    permissions:
      contents: read

    env:
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      REGION: us-central1

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Project ID
        run: |
          # Verify GCP_PROJECT_ID is not empty or whitespace
          if [ -z "$(echo "${{ env.GCP_PROJECT_ID }}" | tr -d '[:space:]')" ]; then
            echo "âŒ ERROR: GCP_PROJECT_ID secret is empty or contains only whitespace"
            exit 1
          fi
          echo "âœ… GCP_PROJECT_ID is set"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Check Firebase config
        working-directory: firebase
        run: |
          echo "=== firebase.json ==="
          cat firebase.json
          echo ""
          echo "=== .firebaserc ==="
          cat .firebaserc
          echo ""
          echo "=== storage.rules exists ==="
          ls -la storage.rules

      - name: Verify Firebase authentication
        run: |
          GCP_PROJECT_ID="${{ env.GCP_PROJECT_ID }}"
          echo "=== Checking authentication ==="
          echo "GOOGLE_APPLICATION_CREDENTIALS: $GOOGLE_APPLICATION_CREDENTIALS"
          echo "Project ID: $GCP_PROJECT_ID"
          echo "Credentials file exists: $(ls -la $GOOGLE_APPLICATION_CREDENTIALS 2>/dev/null || echo 'NOT FOUND')"
          firebase projects:list 2>&1 | head -20 || echo "projects:list failed (may need specific permissions)"

      - name: Deploy Storage Rules
        working-directory: firebase
        run: |
          GCP_PROJECT_ID="${{ env.GCP_PROJECT_ID }}"
          echo "Deploying storage rules to project: $GCP_PROJECT_ID"
          # Use explicit project flag and ensure clean deployment
          firebase deploy --only storage --project="$GCP_PROJECT_ID" --non-interactive --debug 2>&1 | tee deploy-output.txt
          DEPLOY_EXIT_CODE=${PIPESTATUS[0]}
          if [ $DEPLOY_EXIT_CODE -ne 0 ]; then
            echo ""
            echo "=== Deploy failed with exit code $DEPLOY_EXIT_CODE ==="
            echo "=== Checking for common issues ==="
            echo ""
            # Check if Storage API is enabled
            gcloud services list --enabled --filter="name:firebasestorage.googleapis.com" --project="$GCP_PROJECT_ID" 2>/dev/null || echo "Could not check API status"
            exit $DEPLOY_EXIT_CODE
          fi
          echo "âœ… Storage rules deployed successfully"

  notify-deployment:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [check-environment, deploy-firestore, deploy-storage]
    if: always()

    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Firestore:** Rules and indexes deployed" >> $GITHUB_STEP_SUMMARY
          echo "- **Storage:** Rules deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
