name: Deploy to Production

# PRODUCTION DEPLOYMENT
# Triggered by: git tag v* && git push origin v*
# Handles:
# - Updating prod branch (triggers Vercel frontend deployment)
# - Building and pushing backend Docker image
# - Deploying backend to Cloud Run

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  GCP_REGION: northamerica-northeast2
  IMAGE_NAME: ishkul-backend

jobs:
  deploy:
    name: Deploy ${{ github.ref_name }}
    runs-on: ubuntu-latest
    # Use production environment - all secrets come from here
    environment: production
    outputs:
      service_url: ${{ steps.deploy.outputs.service_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate release tag
        run: |
          VERSION="${{ github.ref_name }}"
          COMMIT="${{ github.sha }}"
          MAIN_COMMIT=$(git rev-parse origin/main)

          echo "Release: ${VERSION}"
          echo "Commit: ${COMMIT}"
          echo "Main: ${MAIN_COMMIT}"

          if [ "${COMMIT}" != "${MAIN_COMMIT}" ]; then
            echo "Warning: Tag is not on main branch (allowed for hotfixes)"
          fi

      - name: Update prod branch (triggers Vercel)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git push origin ${{ github.sha }}:refs/heads/prod --force
          echo "Prod branch updated - Vercel will deploy frontend"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Build Docker image
        run: |
          REGISTRY="${{ env.GCP_REGION }}-docker.pkg.dev"
          IMAGE_TAG="${REGISTRY}/${{ secrets.GCP_PROJECT_ID }}/cloud-run-source-deploy/${{ env.IMAGE_NAME }}:${{ github.ref_name }}"
          LATEST_TAG="${REGISTRY}/${{ secrets.GCP_PROJECT_ID }}/cloud-run-source-deploy/${{ env.IMAGE_NAME }}:latest"

          docker build -t "$IMAGE_TAG" -t "$LATEST_TAG" -f backend/Dockerfile .

          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV

      - name: Push Docker image
        run: |
          docker push ${{ env.IMAGE_TAG }}
          docker push ${{ env.LATEST_TAG }}

      - name: Prepare environment variables
        run: |
          cat > /tmp/env-vars.yaml << 'EOF'
          ENVIRONMENT: "production"
          FIREBASE_DATABASE_URL: "${{ secrets.FIREBASE_DATABASE_URL }}"
          FIREBASE_STORAGE_BUCKET: "${{ secrets.FIREBASE_STORAGE_BUCKET }}"
          EOF

          # Add optional secrets
          [ -n "${{ secrets.ALLOWED_ORIGINS }}" ] && echo "ALLOWED_ORIGINS: \"${{ secrets.ALLOWED_ORIGINS }}\"" >> /tmp/env-vars.yaml
          [ -n "${{ secrets.OPENAI_API_KEY }}" ] && echo "OPENAI_API_KEY: \"${{ secrets.OPENAI_API_KEY }}\"" >> /tmp/env-vars.yaml
          [ -n "${{ secrets.GOOGLE_WEB_CLIENT_ID }}" ] && echo "GOOGLE_WEB_CLIENT_ID: \"${{ secrets.GOOGLE_WEB_CLIENT_ID }}\"" >> /tmp/env-vars.yaml
          [ -n "${{ secrets.STRIPE_SECRET_KEY }}" ] && echo "STRIPE_SECRET_KEY: \"${{ secrets.STRIPE_SECRET_KEY }}\"" >> /tmp/env-vars.yaml
          [ -n "${{ secrets.STRIPE_WEBHOOK_SECRET }}" ] && echo "STRIPE_WEBHOOK_SECRET: \"${{ secrets.STRIPE_WEBHOOK_SECRET }}\"" >> /tmp/env-vars.yaml
          [ -n "${{ secrets.STRIPE_PRO_PRICE_ID }}" ] && echo "STRIPE_PRO_PRICE_ID: \"${{ secrets.STRIPE_PRO_PRICE_ID }}\"" >> /tmp/env-vars.yaml
          [ -n "${{ secrets.APP_URL }}" ] && echo "APP_URL: \"${{ secrets.APP_URL }}\"" >> /tmp/env-vars.yaml
          [ -n "${{ secrets.JWT_SECRET }}" ] && echo "JWT_SECRET: \"${{ secrets.JWT_SECRET }}\"" >> /tmp/env-vars.yaml
          [ -n "${{ secrets.ENCRYPTION_KEY }}" ] && echo "ENCRYPTION_KEY: \"${{ secrets.ENCRYPTION_KEY }}\"" >> /tmp/env-vars.yaml

      - name: Deploy to Cloud Run
        id: deploy
        run: |
          VERSION_LABEL=$(echo "${{ github.ref_name }}" | tr '.' '-')

          gcloud run deploy ishkul-backend \
            --image=${{ env.IMAGE_TAG }} \
            --region=${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --env-vars-file=/tmp/env-vars.yaml \
            --min-instances=1 \
            --max-instances=100 \
            --memory=1Gi \
            --cpu=2 \
            --timeout=300 \
            --labels="environment=production,version=${VERSION_LABEL}"

          SERVICE_URL=$(gcloud run services describe ishkul-backend \
            --region=${{ env.GCP_REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --format='value(status.url)')
          echo "service_url=${SERVICE_URL}" >> $GITHUB_OUTPUT

      - name: Verify deployment
        run: |
          sleep 5
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.deploy.outputs.service_url }}/health" || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "Health check passed!"
          else
            echo "Health check returned: $HTTP_CODE (may need warm-up)"
          fi

      - name: Create release summary
        run: |
          echo "## Production Release Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Backend URL** | ${{ steps.deploy.outputs.service_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Frontend URL** | https://ishkul.org |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployments" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: Cloud Run (deployed)" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: Vercel (triggered via prod branch)" >> $GITHUB_STEP_SUMMARY
