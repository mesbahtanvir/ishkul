name: Deploy Backend Preview

# PREVIEW DEPLOYMENT
# Triggered on PRs that modify backend code
# Deploys to STAGING GCP project for isolation from production

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'backend/**'
      - 'prompts/**'
      - 'cloudbuild.yaml'
      - '.dockerignore'
      - '.github/workflows/deploy-backend-preview.yml'

# Cancel previous runs for the same PR when new commits are pushed
concurrency:
  group: preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  GCP_REGION: northamerica-northeast2
  IMAGE_NAME: ishkul-backend

jobs:
  deploy:
    name: Deploy Preview PR-${{ github.event.pull_request.number }}
    runs-on: ubuntu-latest
    # Use staging environment - all secrets come from here
    environment: staging
    outputs:
      service_url: ${{ steps.deploy.outputs.service_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set variables
        id: vars
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "service_name=ishkul-backend-pr-${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "collection_prefix=pr_${PR_NUMBER}_" >> $GITHUB_OUTPUT
          echo "image_tag=pr-${PR_NUMBER}-${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCP Artifact Registry
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Build Docker image
        run: |
          REGISTRY="${{ env.GCP_REGION }}-docker.pkg.dev"
          IMAGE_TAG="${REGISTRY}/${{ secrets.GCP_PROJECT_ID }}/cloud-run-source-deploy/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.image_tag }}"
          echo "Building image: $IMAGE_TAG"
          docker build -t "$IMAGE_TAG" -f backend/Dockerfile .
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Push Docker image
        run: docker push ${{ env.IMAGE_TAG }}

      - name: Prepare environment variables
        run: |
          cat > /tmp/env-vars.yaml << 'EOF'
          ENVIRONMENT: "preview"
          FIREBASE_DATABASE_URL: "${{ secrets.FIREBASE_DATABASE_URL }}"
          FIREBASE_STORAGE_BUCKET: "${{ secrets.FIREBASE_STORAGE_BUCKET }}"
          FIRESTORE_COLLECTION_PREFIX: "${{ steps.vars.outputs.collection_prefix }}"
          ALLOWED_ORIGINS: "http://localhost:3000,http://localhost:8081,https://ishkul.vercel.app,https://ishkul-*.vercel.app"
          EOF

          # Add optional secrets if available
          [ -n "${{ secrets.OPENAI_API_KEY }}" ] && echo "OPENAI_API_KEY: \"${{ secrets.OPENAI_API_KEY }}\"" >> /tmp/env-vars.yaml
          [ -n "${{ secrets.GOOGLE_WEB_CLIENT_ID }}" ] && echo "GOOGLE_WEB_CLIENT_ID: \"${{ secrets.GOOGLE_WEB_CLIENT_ID }}\"" >> /tmp/env-vars.yaml
          [ -n "${{ secrets.JWT_SECRET }}" ] && echo "JWT_SECRET: \"${{ secrets.JWT_SECRET }}\"" >> /tmp/env-vars.yaml
          [ -n "${{ secrets.ENCRYPTION_KEY }}" ] && echo "ENCRYPTION_KEY: \"${{ secrets.ENCRYPTION_KEY }}\"" >> /tmp/env-vars.yaml

          echo "Environment variables prepared"

      - name: Deploy to Cloud Run
        id: deploy
        run: |
          gcloud run deploy ${{ steps.vars.outputs.service_name }} \
            --image=${{ env.IMAGE_TAG }} \
            --region=${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --env-vars-file=/tmp/env-vars.yaml \
            --min-instances=0 \
            --max-instances=2 \
            --memory=512Mi \
            --cpu=1 \
            --timeout=300 \
            --labels="environment=preview,pr=${{ steps.vars.outputs.pr_number }}"

          SERVICE_URL=$(gcloud run services describe ${{ steps.vars.outputs.service_name }} \
            --region=${{ env.GCP_REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --format='value(status.url)')
          echo "service_url=${SERVICE_URL}" >> $GITHUB_OUTPUT

      - name: Verify deployment
        run: |
          sleep 3
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.deploy.outputs.service_url }}/health" || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "Health check passed!"
          else
            echo "Health check returned: $HTTP_CODE (may need warm-up)"
          fi

  comment:
    name: Comment on PR
    needs: deploy
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Comment on PR with Preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{ needs.deploy.outputs.service_url }}';
            const prNumber = ${{ github.event.pull_request.number }};

            const body = `## Backend Preview Deployed

            | Resource | Value |
            |----------|-------|
            | **Preview URL** | ${previewUrl} |
            | **Service** | \`ishkul-backend-pr-${prNumber}\` |
            | **Data Prefix** | \`pr_${prNumber}_\` |
            | **Environment** | Staging GCP project |
            | **Commit** | \`${{ github.sha }}\` |

            ### Preview Notes
            - Deployed to **staging GCP project** (isolated from production)
            - Uses **prefixed Firestore collections** for data isolation
            - Data cleaned up automatically when PR closes
            - Stripe payments **disabled**

            ### Test Endpoints
            - Health: ${previewUrl}/health
            - API: ${previewUrl}/api

            ---
            *Preview auto-deleted when PR closes.*`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const existingComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('Backend Preview Deployed')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body,
              });
            }
