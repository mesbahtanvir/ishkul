name: Deploy Backend Preview

# PREVIEW DEPLOYMENT
# Triggered on PRs that modify backend code
# Uses the reusable workflow for consistent deployment architecture

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'backend/**'
      - 'prompts/**'
      - 'cloudbuild.yaml'
      - '.dockerignore'
      - '.github/workflows/deploy-backend-preview.yml'
      - '.github/workflows/deploy-backend-reusable.yml'

# Cancel previous runs for the same PR when new commits are pushed
concurrency:
  group: preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  prepare:
    name: Prepare Preview Config
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.config.outputs.pr_number }}
      service_name: ${{ steps.config.outputs.service_name }}
      collection_prefix: ${{ steps.config.outputs.collection_prefix }}
      image_tag: ${{ steps.config.outputs.image_tag }}

    steps:
      - name: Generate configuration
        id: config
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "service_name=ishkul-backend-pr-${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "collection_prefix=pr_${PR_NUMBER}_" >> $GITHUB_OUTPUT
          echo "image_tag=pr-${PR_NUMBER}-${{ github.sha }}" >> $GITHUB_OUTPUT

  deploy:
    name: Deploy Preview
    needs: prepare
    uses: ./.github/workflows/deploy-backend-reusable.yml
    with:
      environment: preview
      service_name: ${{ needs.prepare.outputs.service_name }}
      image_tag: ${{ needs.prepare.outputs.image_tag }}
      collection_prefix: ${{ needs.prepare.outputs.collection_prefix }}
      min_instances: 0
      max_instances: 2
      memory: '512Mi'
      cpu: 1
      stripe_mode: 'disabled'
      pr_number: ${{ needs.prepare.outputs.pr_number }}
    secrets:
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      FIREBASE_DATABASE_URL: ${{ secrets.FIREBASE_DATABASE_URL }}
      FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GOOGLE_WEB_CLIENT_ID: ${{ secrets.GOOGLE_WEB_CLIENT_ID }}
      GOOGLE_IOS_CLIENT_ID: ${{ secrets.GOOGLE_IOS_CLIENT_ID }}
      GOOGLE_ANDROID_CLIENT_ID: ${{ secrets.GOOGLE_ANDROID_CLIENT_ID }}

  comment:
    name: Comment on PR
    needs: [prepare, deploy]
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Comment on PR with Preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{ needs.deploy.outputs.service_url }}';
            const prNumber = ${{ needs.prepare.outputs.pr_number }};
            const collectionPrefix = '${{ needs.prepare.outputs.collection_prefix }}';
            const serviceName = '${{ needs.prepare.outputs.service_name }}';

            const body = `## ðŸš€ Backend Preview Deployed!

            | Resource | Value |
            |----------|-------|
            | **Preview URL** | ${previewUrl} |
            | **Service** | \`${serviceName}\` |
            | **Data Prefix** | \`${collectionPrefix}\` |
            | **Region** | northamerica-northeast2 |
            | **Commit** | \`${{ github.sha }}\` |

            ### âš ï¸ Preview Environment Notes
            - Uses **isolated Firestore collections** (prefixed with \`${collectionPrefix}\`)
            - Data will be **automatically cleaned up** when PR is closed/merged
            - Stripe payments are **disabled** in preview
            - Min instances: 0 (may have cold start delay)

            ### ðŸ”— Test Endpoints
            - Health: ${previewUrl}/health
            - API Base: ${previewUrl}/api

            ---
            *This preview will be automatically deleted when the PR is closed.*`;

            // Find existing comment to update
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const existingComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('Backend Preview Deployed')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body,
              });
            }
