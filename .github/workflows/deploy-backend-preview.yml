name: Deploy Backend Preview

# PREVIEW DEPLOYMENT
# Triggered on PRs that modify backend code
# Automatically cancels previous runs when new commits are pushed

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'backend/**'
      - 'prompts/**'
      - 'cloudbuild.yaml'
      - '.dockerignore'
      - '.github/workflows/deploy-backend-preview.yml'

# Cancel previous runs for the same PR when new commits are pushed
# This saves resources and ensures only the latest code is deployed
concurrency:
  group: preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: northamerica-northeast2
  IMAGE_NAME: ishkul-backend

jobs:
  build-and-deploy-preview:
    name: Deploy Backend Preview
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get PR Number
        id: pr
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          echo "number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "service_name=ishkul-backend-pr-${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "collection_prefix=pr_${PR_NUMBER}_" >> $GITHUB_OUTPUT

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCP Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Build Docker image
        run: |
          REGISTRY="${{ env.GCP_REGION }}-docker.pkg.dev"
          IMAGE_TAG="${REGISTRY}/${{ env.GCP_PROJECT_ID }}/cloud-run-source-deploy/${{ env.IMAGE_NAME }}:pr-${{ steps.pr.outputs.number }}-${{ github.sha }}"

          echo "Building image: $IMAGE_TAG"
          docker build -t "$IMAGE_TAG" -f backend/Dockerfile .

          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Push Docker image to Artifact Registry
        run: |
          docker push ${{ env.IMAGE_TAG }}

      - name: Prepare environment variables for Preview
        id: prepare-env
        run: |
          # Create env vars YAML file for Cloud Run (avoids escaping issues with URLs)
          cat > /tmp/env-vars.yaml << 'ENVEOF'
          ENVIRONMENT: preview
          FIRESTORE_COLLECTION_PREFIX: "${{ steps.pr.outputs.collection_prefix }}"
          FIREBASE_DATABASE_URL: "${{ secrets.FIREBASE_DATABASE_URL }}"
          FIREBASE_STORAGE_BUCKET: "${{ secrets.FIREBASE_STORAGE_BUCKET }}"
          ALLOWED_ORIGINS: "http://localhost:3000,http://localhost:8081,http://localhost:19006,https://ishkul.vercel.app,https://ishkul.org,https://ishkul-*.vercel.app"
          ENVEOF

          # Add optional secrets if they exist
          if [ -n "${{ secrets.GOOGLE_WEB_CLIENT_ID }}" ]; then
            echo "GOOGLE_WEB_CLIENT_ID: \"${{ secrets.GOOGLE_WEB_CLIENT_ID }}\"" >> /tmp/env-vars.yaml
          fi
          if [ -n "${{ secrets.GOOGLE_IOS_CLIENT_ID }}" ]; then
            echo "GOOGLE_IOS_CLIENT_ID: \"${{ secrets.GOOGLE_IOS_CLIENT_ID }}\"" >> /tmp/env-vars.yaml
          fi
          if [ -n "${{ secrets.GOOGLE_ANDROID_CLIENT_ID }}" ]; then
            echo "GOOGLE_ANDROID_CLIENT_ID: \"${{ secrets.GOOGLE_ANDROID_CLIENT_ID }}\"" >> /tmp/env-vars.yaml
          fi
          if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "OPENAI_API_KEY: \"${{ secrets.OPENAI_API_KEY }}\"" >> /tmp/env-vars.yaml
          fi

          # NOTE: Stripe is NOT configured for preview to avoid accidental charges

          echo "Env vars file created:"
          cat /tmp/env-vars.yaml

      - name: Deploy Preview to Cloud Run
        id: deploy
        run: |
          # Deploy as a new Cloud Run service for this PR
          gcloud run deploy ${{ steps.pr.outputs.service_name }} \
            --image=${{ env.IMAGE_TAG }} \
            --region=${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --project=${{ env.GCP_PROJECT_ID }} \
            --env-vars-file=/tmp/env-vars.yaml \
            --min-instances=0 \
            --max-instances=2 \
            --memory=512Mi \
            --cpu=1 \
            --timeout=300 \
            --labels="environment=preview,pr=${{ steps.pr.outputs.number }}"

          # Get the service URL
          SERVICE_URL=$(gcloud run services describe ${{ steps.pr.outputs.service_name }} \
            --region=${{ env.GCP_REGION }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --format='value(status.url)')

          echo "preview_url=${SERVICE_URL}" >> $GITHUB_OUTPUT

      - name: Comment on PR with Preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{ steps.deploy.outputs.preview_url }}';
            const prNumber = ${{ steps.pr.outputs.number }};
            const collectionPrefix = '${{ steps.pr.outputs.collection_prefix }}';

            const body = `## ðŸš€ Backend Preview Deployed!

            | Resource | Value |
            |----------|-------|
            | **Preview URL** | ${previewUrl} |
            | **Service** | \`${{ steps.pr.outputs.service_name }}\` |
            | **Data Prefix** | \`${collectionPrefix}\` |
            | **Region** | ${{ env.GCP_REGION }} |
            | **Commit** | \`${{ github.sha }}\` |

            ### âš ï¸ Preview Environment Notes
            - Uses **isolated Firestore collections** (prefixed with \`${collectionPrefix}\`)
            - Data will be **automatically cleaned up** when PR is closed/merged
            - Stripe payments are **disabled** in preview
            - Min instances: 0 (may have cold start delay)

            ### ðŸ”— Test Endpoints
            - Health: ${previewUrl}/health
            - API Base: ${previewUrl}/api

            ---
            *This preview will be automatically deleted when the PR is closed.*`;

            // Find existing comment to update
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const existingComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('Backend Preview Deployed')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body,
              });
            }

      - name: Summary
        run: |
          echo "## Backend Preview Deployment Summary ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Service:** ${{ steps.pr.outputs.service_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** ${{ steps.deploy.outputs.preview_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Region:** ${{ env.GCP_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Collection Prefix:** ${{ steps.pr.outputs.collection_prefix }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** ${{ env.IMAGE_TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Preview deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
