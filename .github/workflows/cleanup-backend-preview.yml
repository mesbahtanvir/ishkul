name: Cleanup Backend Preview

on:
  pull_request:
    types: [closed]
    paths:
      - 'backend/**'
      - 'prompts/**'
      - 'cloudbuild.yaml'
      - '.dockerignore'
      - '.github/workflows/deploy-backend-preview.yml'

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: northamerica-northeast2

jobs:
  cleanup-preview:
    name: Cleanup Backend Preview
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get PR Number
        id: pr
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          echo "number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "service_name=ishkul-backend-pr-${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "collection_prefix=pr_${PR_NUMBER}_" >> $GITHUB_OUTPUT

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Check if preview service exists
        id: check
        run: |
          if gcloud run services describe ${{ steps.pr.outputs.service_name }} \
            --region=${{ env.GCP_REGION }} \
            --project=${{ env.GCP_PROJECT_ID }} > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Preview service does not exist, skipping cleanup"
          fi

      - name: Delete Cloud Run preview service
        if: steps.check.outputs.exists == 'true'
        run: |
          echo "Deleting Cloud Run service: ${{ steps.pr.outputs.service_name }}"
          gcloud run services delete ${{ steps.pr.outputs.service_name }} \
            --region=${{ env.GCP_REGION }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --quiet

      - name: Setup Go for Firestore cleanup
        if: steps.check.outputs.exists == 'true'
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache-dependency-path: backend/go.sum

      - name: Cleanup Firestore preview data
        if: steps.check.outputs.exists == 'true'
        run: |
          # Create a small Go script to clean up Firestore data
          cat > /tmp/cleanup.go << 'CLEANUP_EOF'
          package main

          import (
            "context"
            "fmt"
            "log"
            "os"

            "cloud.google.com/go/firestore"
            "google.golang.org/api/iterator"
          )

          func main() {
            ctx := context.Background()
            prefix := os.Getenv("COLLECTION_PREFIX")
            projectID := os.Getenv("GCP_PROJECT_ID")

            if prefix == "" || projectID == "" {
              log.Fatal("COLLECTION_PREFIX and GCP_PROJECT_ID must be set")
            }

            client, err := firestore.NewClient(ctx, projectID)
            if err != nil {
              log.Fatalf("Failed to create Firestore client: %v", err)
            }
            defer client.Close()

            // Collections to clean up
            collections := []string{"users", "learning_paths"}

            for _, col := range collections {
              prefixedCol := prefix + col
              fmt.Printf("Cleaning up collection: %s\n", prefixedCol)

              iter := client.Collection(prefixedCol).Documents(ctx)
              batch := client.Batch()
              batchSize := 0
              totalDeleted := 0

              for {
                doc, err := iter.Next()
                if err == iterator.Done {
                  break
                }
                if err != nil {
                  log.Printf("Error iterating: %v", err)
                  break
                }

                batch.Delete(doc.Ref)
                batchSize++
                totalDeleted++

                // Commit every 500 docs (Firestore limit)
                if batchSize >= 500 {
                  if _, err := batch.Commit(ctx); err != nil {
                    log.Printf("Error committing batch: %v", err)
                  }
                  batch = client.Batch()
                  batchSize = 0
                }
              }

              // Commit remaining
              if batchSize > 0 {
                if _, err := batch.Commit(ctx); err != nil {
                  log.Printf("Error committing final batch: %v", err)
                }
              }

              fmt.Printf("Deleted %d documents from %s\n", totalDeleted, prefixedCol)
            }

            fmt.Println("Firestore cleanup completed!")
          }
          CLEANUP_EOF

          # Initialize Go module and run cleanup
          cd /tmp
          go mod init cleanup
          go mod tidy

          COLLECTION_PREFIX="${{ steps.pr.outputs.collection_prefix }}" \
          GCP_PROJECT_ID="${{ env.GCP_PROJECT_ID }}" \
          go run cleanup.go

      - name: Delete preview Docker images
        if: steps.check.outputs.exists == 'true'
        run: |
          # List and delete preview images for this PR
          REGISTRY="${{ env.GCP_REGION }}-docker.pkg.dev"
          REPO="${REGISTRY}/${{ env.GCP_PROJECT_ID }}/cloud-run-source-deploy/ishkul-backend"

          echo "Cleaning up Docker images for PR-${{ steps.pr.outputs.number }}"

          # Get all tags for this PR
          TAGS=$(gcloud artifacts docker tags list ${REPO} \
            --filter="tag:pr-${{ steps.pr.outputs.number }}-*" \
            --format="value(tag)" 2>/dev/null || echo "")

          if [ -n "$TAGS" ]; then
            for TAG in $TAGS; do
              echo "Deleting image: ${REPO}:${TAG}"
              gcloud artifacts docker images delete "${REPO}:${TAG}" --quiet || true
            done
          else
            echo "No images found for PR-${{ steps.pr.outputs.number }}"
          fi

      - name: Comment cleanup confirmation on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.number }};
            const existed = '${{ steps.check.outputs.exists }}' === 'true';

            if (!existed) {
              console.log('No preview existed, skipping comment');
              return;
            }

            const body = `## ðŸ§¹ Backend Preview Cleaned Up

            | Action | Status |
            |--------|--------|
            | Cloud Run Service | âœ… Deleted |
            | Firestore Data | âœ… Cleaned (prefix: \`${{ steps.pr.outputs.collection_prefix }}\`) |
            | Docker Images | âœ… Removed |

            The preview environment for this PR has been fully cleaned up. No residual costs will be incurred.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body,
            });

      - name: Summary
        run: |
          echo "## Backend Preview Cleanup Summary ðŸ§¹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check.outputs.exists }}" == "true" ]; then
            echo "- âœ… **Cloud Run Service** deleted: ${{ steps.pr.outputs.service_name }}" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… **Firestore Data** cleaned: prefix \`${{ steps.pr.outputs.collection_prefix }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… **Docker Images** removed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â­ï¸ Preview service did not exist, nothing to clean up" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Cleanup completed!" >> $GITHUB_STEP_SUMMARY
