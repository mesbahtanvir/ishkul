name: Deploy Backend (Reusable)

# REUSABLE WORKFLOW
# Called by preview, staging, and production deployment workflows
# Ensures identical deployment architecture across all environments

on:
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment (preview, staging, production)'
        required: true
        type: string
      service_name:
        description: 'Cloud Run service name'
        required: true
        type: string
      image_tag:
        description: 'Docker image tag suffix (e.g., pr-123-abc1234, staging-abc1234, v1.0.0)'
        required: true
        type: string
      collection_prefix:
        description: 'Firestore collection prefix for data isolation'
        required: false
        type: string
        default: ''
      min_instances:
        description: 'Minimum Cloud Run instances'
        required: false
        type: number
        default: 0
      max_instances:
        description: 'Maximum Cloud Run instances'
        required: false
        type: number
        default: 10
      memory:
        description: 'Memory allocation (e.g., 512Mi, 1Gi)'
        required: false
        type: string
        default: '512Mi'
      cpu:
        description: 'CPU allocation'
        required: false
        type: number
        default: 1
      stripe_mode:
        description: 'Stripe mode (disabled, test, live)'
        required: false
        type: string
        default: 'disabled'
      pr_number:
        description: 'PR number (only for preview deployments)'
        required: false
        type: string
        default: ''
      also_tag_latest:
        description: 'Also tag image as latest (for production)'
        required: false
        type: boolean
        default: false
    outputs:
      service_url:
        description: 'Deployed service URL'
        value: ${{ jobs.deploy.outputs.service_url }}
      image:
        description: 'Full image path'
        value: ${{ jobs.deploy.outputs.image }}
    secrets:
      GCP_PROJECT_ID:
        required: true
      GCP_SA_KEY:
        required: true
      FIREBASE_DATABASE_URL:
        required: true
      FIREBASE_STORAGE_BUCKET:
        required: true
      OPENAI_API_KEY:
        required: false
      GOOGLE_WEB_CLIENT_ID:
        required: false
      GOOGLE_IOS_CLIENT_ID:
        required: false
      GOOGLE_ANDROID_CLIENT_ID:
        required: false
      ALLOWED_ORIGINS:
        required: false
      # Stripe secrets (used based on stripe_mode input)
      STRIPE_SECRET_KEY:
        required: false
      STRIPE_WEBHOOK_SECRET:
        required: false
      STRIPE_PRO_PRICE_ID:
        required: false
      STRIPE_TEST_SECRET_KEY:
        required: false
      STRIPE_TEST_WEBHOOK_SECRET:
        required: false
      STRIPE_TEST_PRO_PRICE_ID:
        required: false
      APP_URL:
        required: false
      # Security secrets
      JWT_SECRET:
        required: false
      ENCRYPTION_KEY:
        required: false

env:
  GCP_REGION: northamerica-northeast2
  IMAGE_NAME: ishkul-backend

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    outputs:
      service_url: ${{ steps.deploy.outputs.service_url }}
      image: ${{ env.IMAGE_TAG }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCP Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Build Docker image
        run: |
          REGISTRY="${{ env.GCP_REGION }}-docker.pkg.dev"
          IMAGE_TAG="${REGISTRY}/${{ secrets.GCP_PROJECT_ID }}/cloud-run-source-deploy/${{ env.IMAGE_NAME }}:${{ inputs.image_tag }}"

          echo "Building image: $IMAGE_TAG"

          if [ "${{ inputs.also_tag_latest }}" = "true" ]; then
            LATEST_TAG="${REGISTRY}/${{ secrets.GCP_PROJECT_ID }}/cloud-run-source-deploy/${{ env.IMAGE_NAME }}:latest"
            docker build -t "$IMAGE_TAG" -t "$LATEST_TAG" -f backend/Dockerfile .
            echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV
          else
            docker build -t "$IMAGE_TAG" -f backend/Dockerfile .
          fi

          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Push Docker image to Artifact Registry
        run: |
          docker push ${{ env.IMAGE_TAG }}
          if [ -n "${{ env.LATEST_TAG }}" ]; then
            docker push ${{ env.LATEST_TAG }}
          fi

      - name: Prepare environment variables
        run: |
          # Create env vars YAML file (avoids escaping issues with URLs)
          cat > /tmp/env-vars.yaml << 'ENVEOF'
          ENVIRONMENT: "${{ inputs.environment }}"
          FIREBASE_DATABASE_URL: "${{ secrets.FIREBASE_DATABASE_URL }}"
          FIREBASE_STORAGE_BUCKET: "${{ secrets.FIREBASE_STORAGE_BUCKET }}"
          ENVEOF

          # Add collection prefix if specified (for data isolation)
          if [ -n "${{ inputs.collection_prefix }}" ]; then
            echo "FIRESTORE_COLLECTION_PREFIX: \"${{ inputs.collection_prefix }}\"" >> /tmp/env-vars.yaml
          fi

          # Add CORS origins
          if [ -n "${{ secrets.ALLOWED_ORIGINS }}" ]; then
            echo "ALLOWED_ORIGINS: \"${{ secrets.ALLOWED_ORIGINS }}\"" >> /tmp/env-vars.yaml
          else
            # Default CORS origins for all environments
            echo "ALLOWED_ORIGINS: \"http://localhost:3000,http://localhost:8081,http://localhost:19006,https://ishkul.vercel.app,https://ishkul.org,https://ishkul-*.vercel.app\"" >> /tmp/env-vars.yaml
          fi

          # Add optional secrets
          if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "OPENAI_API_KEY: \"${{ secrets.OPENAI_API_KEY }}\"" >> /tmp/env-vars.yaml
          fi
          if [ -n "${{ secrets.GOOGLE_WEB_CLIENT_ID }}" ]; then
            echo "GOOGLE_WEB_CLIENT_ID: \"${{ secrets.GOOGLE_WEB_CLIENT_ID }}\"" >> /tmp/env-vars.yaml
          fi
          if [ -n "${{ secrets.GOOGLE_IOS_CLIENT_ID }}" ]; then
            echo "GOOGLE_IOS_CLIENT_ID: \"${{ secrets.GOOGLE_IOS_CLIENT_ID }}\"" >> /tmp/env-vars.yaml
          fi
          if [ -n "${{ secrets.GOOGLE_ANDROID_CLIENT_ID }}" ]; then
            echo "GOOGLE_ANDROID_CLIENT_ID: \"${{ secrets.GOOGLE_ANDROID_CLIENT_ID }}\"" >> /tmp/env-vars.yaml
          fi

          # Stripe configuration based on mode
          STRIPE_MODE="${{ inputs.stripe_mode }}"

          if [ "$STRIPE_MODE" = "live" ]; then
            echo "# Stripe LIVE mode" >> /tmp/env-vars.yaml
            if [ -n "${{ secrets.STRIPE_SECRET_KEY }}" ]; then
              echo "STRIPE_SECRET_KEY: \"${{ secrets.STRIPE_SECRET_KEY }}\"" >> /tmp/env-vars.yaml
            fi
            if [ -n "${{ secrets.STRIPE_WEBHOOK_SECRET }}" ]; then
              echo "STRIPE_WEBHOOK_SECRET: \"${{ secrets.STRIPE_WEBHOOK_SECRET }}\"" >> /tmp/env-vars.yaml
            fi
            if [ -n "${{ secrets.STRIPE_PRO_PRICE_ID }}" ]; then
              echo "STRIPE_PRO_PRICE_ID: \"${{ secrets.STRIPE_PRO_PRICE_ID }}\"" >> /tmp/env-vars.yaml
            fi
          elif [ "$STRIPE_MODE" = "test" ]; then
            echo "# Stripe TEST mode" >> /tmp/env-vars.yaml
            if [ -n "${{ secrets.STRIPE_TEST_SECRET_KEY }}" ]; then
              echo "STRIPE_SECRET_KEY: \"${{ secrets.STRIPE_TEST_SECRET_KEY }}\"" >> /tmp/env-vars.yaml
            fi
            if [ -n "${{ secrets.STRIPE_TEST_WEBHOOK_SECRET }}" ]; then
              echo "STRIPE_WEBHOOK_SECRET: \"${{ secrets.STRIPE_TEST_WEBHOOK_SECRET }}\"" >> /tmp/env-vars.yaml
            fi
            if [ -n "${{ secrets.STRIPE_TEST_PRO_PRICE_ID }}" ]; then
              echo "STRIPE_PRO_PRICE_ID: \"${{ secrets.STRIPE_TEST_PRO_PRICE_ID }}\"" >> /tmp/env-vars.yaml
            fi
          fi
          # If stripe_mode is 'disabled', no Stripe vars are added

          # App URL for Stripe redirects
          if [ -n "${{ secrets.APP_URL }}" ]; then
            echo "APP_URL: \"${{ secrets.APP_URL }}\"" >> /tmp/env-vars.yaml
          fi

          # Security secrets
          if [ -n "${{ secrets.JWT_SECRET }}" ]; then
            echo "JWT_SECRET: \"${{ secrets.JWT_SECRET }}\"" >> /tmp/env-vars.yaml
          fi
          if [ -n "${{ secrets.ENCRYPTION_KEY }}" ]; then
            echo "ENCRYPTION_KEY: \"${{ secrets.ENCRYPTION_KEY }}\"" >> /tmp/env-vars.yaml
          fi

          echo "Environment variables prepared for ${{ inputs.environment }}:"
          cat /tmp/env-vars.yaml

      - name: Deploy to Cloud Run
        id: deploy
        run: |
          gcloud run deploy ${{ inputs.service_name }} \
            --image=${{ env.IMAGE_TAG }} \
            --region=${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --env-vars-file=/tmp/env-vars.yaml \
            --min-instances=${{ inputs.min_instances }} \
            --max-instances=${{ inputs.max_instances }} \
            --memory=${{ inputs.memory }} \
            --cpu=${{ inputs.cpu }} \
            --timeout=300 \
            --labels="environment=${{ inputs.environment }}"

          # Get the service URL
          SERVICE_URL=$(gcloud run services describe ${{ inputs.service_name }} \
            --region=${{ env.GCP_REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --format='value(status.url)')

          echo "service_url=${SERVICE_URL}" >> $GITHUB_OUTPUT

      - name: Verify deployment
        run: |
          echo "Checking health endpoint..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.deploy.outputs.service_url }}/health" || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Health check passed!"
          else
            echo "âš ï¸ Health check returned: $HTTP_CODE (may need warm-up time)"
          fi

      - name: Deployment Summary
        run: |
          STRIPE_STATUS="âŒ Disabled"
          if [ "${{ inputs.stripe_mode }}" = "test" ]; then
            STRIPE_STATUS="ðŸ§ª Test Mode"
          elif [ "${{ inputs.stripe_mode }}" = "live" ]; then
            STRIPE_STATUS="âœ… Live Mode"
          fi

          ENV_EMOJI="ðŸ”§"
          if [ "${{ inputs.environment }}" = "production" ]; then
            ENV_EMOJI="ðŸš€"
          elif [ "${{ inputs.environment }}" = "staging" ]; then
            ENV_EMOJI="ðŸŽ­"
          elif [ "${{ inputs.environment }}" = "preview" ]; then
            ENV_EMOJI="ðŸ‘€"
          fi

          echo "## ${ENV_EMOJI} ${{ inputs.environment }} Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **URL** | ${{ steps.deploy.outputs.service_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Service** | \`${{ inputs.service_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Region** | ${{ env.GCP_REGION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Image** | \`${{ env.IMAGE_TAG }}\` |" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.collection_prefix }}" ]; then
            echo "| **Data Prefix** | \`${{ inputs.collection_prefix }}\` |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "| **Stripe** | ${STRIPE_STATUS} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Resources** | ${{ inputs.cpu }} CPU, ${{ inputs.memory }} RAM |" >> $GITHUB_STEP_SUMMARY
          echo "| **Scaling** | ${{ inputs.min_instances }}-${{ inputs.max_instances }} instances |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
