name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  frontend:
    name: Frontend CI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: TypeScript check
        working-directory: frontend
        run: npx tsc --noEmit

      - name: Lint
        working-directory: frontend
        run: npm run lint

      - name: Build web
        working-directory: frontend
        run: npm run build
        env:
          EXPO_PUBLIC_FIREBASE_API_KEY: ${{ secrets.EXPO_PUBLIC_FIREBASE_API_KEY || 'dummy-key' }}
          EXPO_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.EXPO_PUBLIC_FIREBASE_AUTH_DOMAIN || 'dummy-domain' }}
          EXPO_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.EXPO_PUBLIC_FIREBASE_PROJECT_ID || 'dummy-project' }}
          EXPO_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.EXPO_PUBLIC_FIREBASE_STORAGE_BUCKET || 'dummy-bucket' }}
          EXPO_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.EXPO_PUBLIC_FIREBASE_MESSAGING_SENDER_ID || 'dummy-sender' }}
          EXPO_PUBLIC_FIREBASE_APP_ID: ${{ secrets.EXPO_PUBLIC_FIREBASE_APP_ID || 'dummy-app-id' }}
          EXPO_PUBLIC_GOOGLE_WEB_CLIENT_ID: ${{ secrets.EXPO_PUBLIC_GOOGLE_WEB_CLIENT_ID || 'dummy-web-client' }}
          EXPO_PUBLIC_GOOGLE_IOS_CLIENT_ID: ${{ secrets.EXPO_PUBLIC_GOOGLE_IOS_CLIENT_ID || 'dummy-ios-client' }}
          EXPO_PUBLIC_GOOGLE_ANDROID_CLIENT_ID: ${{ secrets.EXPO_PUBLIC_GOOGLE_ANDROID_CLIENT_ID || 'dummy-android-client' }}

      - name: Run tests
        working-directory: frontend
        run: npm test

      - name: Check bundle size
        run: |
          if [ -d "frontend/dist" ]; then
            echo "Build output size:"
            du -sh frontend/dist/
            echo "JavaScript bundles:"
            find frontend/dist -name "*.js" -exec du -h {} \;
          fi

  backend:
    name: Backend CI (Go)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache-dependency-path: backend/go.sum

      - name: Verify go.mod is tidy
        working-directory: backend
        run: |
          go mod tidy
          git diff --exit-code go.mod go.sum

      - name: Check formatting
        working-directory: backend
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "The following files are not formatted correctly:"
            gofmt -l .
            echo ""
            echo "Run 'gofmt -w .' to fix formatting"
            exit 1
          fi

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          working-directory: backend

      - name: Build
        working-directory: backend
        run: go build -v ./...

      - name: Run tests
        working-directory: backend
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-coverage
          path: backend/coverage.out
          retention-days: 7

  backend-docker:
    name: Backend Docker Build (Validation Only)
    runs-on: ubuntu-latest
    # Only run on PRs to validate Docker build without deploying
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (no push)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: backend/Dockerfile
          push: false
          load: true  # Load image into local Docker daemon
          tags: ishkul-backend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test container starts
        run: |
          # Run container and capture output
          # Container will exit because Firebase credentials aren't available in CI
          # We just verify the binary runs and produces expected output
          docker run --rm \
            -e PORT=8080 \
            -e ENVIRONMENT=test \
            ishkul-backend:test 2>&1 | tee /tmp/container-output.txt &

          CONTAINER_PID=$!

          # Wait a few seconds for container to start and produce output
          sleep 3

          # Check if we see expected startup messages (proves binary runs)
          if grep -q "FIREBASE_DATABASE_URL not set\|application_startup\|Firebase" /tmp/container-output.txt; then
            echo "✅ Container binary executed successfully!"
            echo "Output shows Go application started and attempted Firebase initialization"
            cat /tmp/container-output.txt
          else
            echo "❌ Container didn't produce expected output"
            cat /tmp/container-output.txt
            exit 1
          fi

          # Kill the background process (it will exit anyway due to missing credentials)
          kill $CONTAINER_PID 2>/dev/null || true
