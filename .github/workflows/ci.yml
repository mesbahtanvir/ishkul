name: CI

on:
  push:
    branches: [main]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - '.github/workflows/ci.yml'
      - '.github/actions/**'
  pull_request:
    branches: [main]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - '.github/workflows/ci.yml'
      - '.github/actions/**'

# Cancel previous CI runs for the same ref (branch/PR)
# For PRs: cancel in-progress when new commits are pushed
# For main: don't cancel (we want all commits tested)
concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  # Determine which jobs need to run based on changed files
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            frontend:
              - 'frontend/**'
              - '.github/workflows/ci.yml'
            backend:
              - 'backend/**'
              - '.github/workflows/ci.yml'

  frontend:
    name: Frontend CI
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.frontend == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: TypeScript check
        working-directory: frontend
        run: npx tsc --noEmit

      - name: Lint
        working-directory: frontend
        run: npm run lint

      - name: Build web
        working-directory: frontend
        run: npm run build
        env:
          EXPO_PUBLIC_FIREBASE_API_KEY: ${{ secrets.EXPO_PUBLIC_FIREBASE_API_KEY || 'dummy-key' }}
          EXPO_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.EXPO_PUBLIC_FIREBASE_AUTH_DOMAIN || 'dummy-domain' }}
          EXPO_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.EXPO_PUBLIC_FIREBASE_PROJECT_ID || 'dummy-project' }}
          EXPO_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.EXPO_PUBLIC_FIREBASE_STORAGE_BUCKET || 'dummy-bucket' }}
          EXPO_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.EXPO_PUBLIC_FIREBASE_MESSAGING_SENDER_ID || 'dummy-sender' }}
          EXPO_PUBLIC_FIREBASE_APP_ID: ${{ secrets.EXPO_PUBLIC_FIREBASE_APP_ID || 'dummy-app-id' }}
          EXPO_PUBLIC_GOOGLE_WEB_CLIENT_ID: ${{ secrets.EXPO_PUBLIC_GOOGLE_WEB_CLIENT_ID || 'dummy-web-client' }}
          EXPO_PUBLIC_GOOGLE_IOS_CLIENT_ID: ${{ secrets.EXPO_PUBLIC_GOOGLE_IOS_CLIENT_ID || 'dummy-ios-client' }}
          EXPO_PUBLIC_GOOGLE_ANDROID_CLIENT_ID: ${{ secrets.EXPO_PUBLIC_GOOGLE_ANDROID_CLIENT_ID || 'dummy-android-client' }}

      - name: Run tests
        working-directory: frontend
        run: npm test

      - name: Check bundle size
        run: |
          if [ -d "frontend/dist" ]; then
            echo "Build output size:"
            du -sh frontend/dist/
            echo "JavaScript bundles:"
            find frontend/dist -name "*.js" -exec du -h {} \;
          fi

  backend:
    name: Backend CI (Go)
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache-dependency-path: backend/go.sum

      - name: Verify go.mod is tidy
        working-directory: backend
        run: |
          go mod tidy
          git diff --exit-code go.mod go.sum

      - name: Check formatting
        working-directory: backend
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "The following files are not formatted correctly:"
            gofmt -l .
            echo ""
            echo "Run 'gofmt -w .' to fix formatting"
            exit 1
          fi

      - name: Run go vet
        working-directory: backend
        run: go vet ./...

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          working-directory: backend

      - name: Build
        working-directory: backend
        run: go build -v ./...

      - name: Run tests
        working-directory: backend
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-coverage
          path: backend/coverage.out
          retention-days: 7

  backend-docker:
    name: Backend Docker Build (Validation Only)
    runs-on: ubuntu-latest
    needs: changes
    # Disabled on PRs to reduce resource usage - Docker build validation happens on main
    # To re-enable: change 'false' to: github.event_name == 'pull_request' && needs.changes.outputs.backend == 'true'
    if: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (no push)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: backend/Dockerfile
          push: false
          load: true  # Load image into local Docker daemon
          tags: ishkul-backend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test container starts
        run: |
          # Run container and capture output
          # Container will exit because Firebase credentials aren't available in CI
          # We just verify the binary runs and produces expected output
          docker run --rm \
            -e PORT=8080 \
            -e ENVIRONMENT=test \
            ishkul-backend:test 2>&1 | tee /tmp/container-output.txt &

          CONTAINER_PID=$!

          # Wait a few seconds for container to start and produce output
          sleep 3

          # Check if we see expected startup messages (proves binary runs)
          if grep -q "FIREBASE_DATABASE_URL not set\|application_startup\|Firebase" /tmp/container-output.txt; then
            echo "✅ Container binary executed successfully!"
            echo "Output shows Go application started and attempted Firebase initialization"
            cat /tmp/container-output.txt
          else
            echo "❌ Container didn't produce expected output"
            cat /tmp/container-output.txt
            exit 1
          fi

          # Kill the background process (it will exit anyway due to missing credentials)
          kill $CONTAINER_PID 2>/dev/null || true

  # Security scanning job
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: changes
    # Run security scan if either frontend or backend changed
    if: needs.changes.outputs.frontend == 'true' || needs.changes.outputs.backend == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (filesystem)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
        continue-on-error: true  # Don't block CI, but report issues

      - name: Run Trivy (SARIF output for GitHub Security)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # Summary job that always runs to report status
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [changes, frontend, backend, backend-docker, security]
    if: always()

    steps:
      - name: Check CI Status
        run: |
          echo "## CI Status Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if jobs were skipped or failed
          FRONTEND="${{ needs.frontend.result }}"
          BACKEND="${{ needs.backend.result }}"
          DOCKER="${{ needs.backend-docker.result }}"
          SECURITY="${{ needs.security.result }}"

          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "$FRONTEND" == "success" ]; then
            echo "| Frontend | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "$FRONTEND" == "skipped" ]; then
            echo "| Frontend | ⏭️ Skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Frontend | ❌ $FRONTEND |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$BACKEND" == "success" ]; then
            echo "| Backend | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "$BACKEND" == "skipped" ]; then
            echo "| Backend | ⏭️ Skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Backend | ❌ $BACKEND |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$DOCKER" == "success" ]; then
            echo "| Docker Build | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "$DOCKER" == "skipped" ]; then
            echo "| Docker Build | ⏭️ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Docker Build | ❌ $DOCKER |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$SECURITY" == "success" ]; then
            echo "| Security Scan | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "$SECURITY" == "skipped" ]; then
            echo "| Security Scan | ⏭️ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Security Scan | ⚠️ $SECURITY |" >> $GITHUB_STEP_SUMMARY
          fi

          # Fail if any required job failed
          if [ "$FRONTEND" == "failure" ] || [ "$BACKEND" == "failure" ]; then
            echo ""
            echo "❌ CI failed - required jobs did not pass"
            exit 1
          fi

          echo ""
          echo "✅ CI completed successfully"
