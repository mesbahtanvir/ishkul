name: Release and Deploy to Production

# Unified production deployment workflow
# Triggered by: git tag v* && git push origin v*
# Automatically handles:
# - Updating prod branch (triggers Vercel frontend deployment)
# - Building and pushing backend Docker image
# - Deploying backend to Cloud Run
# - Complete in single workflow, no manual steps needed

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  GCP_REGION: northamerica-northeast2
  IMAGE_NAME: ishkul-backend

jobs:
  check-environment:
    name: Check Production Environment
    runs-on: ubuntu-latest
    environment: production

  release:
    name: Release v${{ github.ref_name }}
    runs-on: ubuntu-latest
    needs: check-environment

    steps:
      # Step 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 2: Validate tag is on main branch
      - name: Validate release tag
        run: |
          VERSION="${{ github.ref_name }}"
          COMMIT="${{ github.sha }}"

          echo "ðŸš€ Validating release: ${VERSION}"
          echo "Commit: ${COMMIT}"

          # Get the list of tags that point to main
          MAIN_COMMIT=$(git rev-parse origin/main)
          echo "Main branch commit: ${MAIN_COMMIT}"

          if [ "${COMMIT}" != "${MAIN_COMMIT}" ]; then
            echo "âš ï¸  Warning: Tag ${VERSION} is not on main branch"
            echo "   Tag commit: ${COMMIT}"
            echo "   Main commit: ${MAIN_COMMIT}"
            echo ""
            echo "This is allowed for hotfixes, but verify the commit is correct."
          fi

          echo "âœ… Tag validation complete"

      # Step 3: Update prod branch
      - name: Update prod branch
        run: |
          VERSION="${{ github.ref_name }}"
          COMMIT="${{ github.sha }}"

          echo "Updating prod branch to ${VERSION}..."

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Force update prod branch to this tag's commit
          git push origin ${COMMIT}:refs/heads/prod --force

          echo "âœ… Prod branch updated to ${VERSION}"

      # Step 4: Authenticate to Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # Step 5: Setup Cloud SDK
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Step 6: Configure Docker for GCP Artifact Registry
      - name: Configure Docker for GCP Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      # Step 7: Build Docker image
      - name: Build Docker image
        run: |
          REGISTRY="${{ env.GCP_REGION }}-docker.pkg.dev"
          IMAGE_TAG="${REGISTRY}/${{ secrets.GCP_PROJECT_ID }}/cloud-run-source-deploy/${{ env.IMAGE_NAME }}:${{ github.ref_name }}"
          LATEST_TAG="${REGISTRY}/${{ secrets.GCP_PROJECT_ID }}/cloud-run-source-deploy/${{ env.IMAGE_NAME }}:latest"

          echo "Building image: $IMAGE_TAG"

          docker build -t "$IMAGE_TAG" -t "$LATEST_TAG" -f backend/Dockerfile .

          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV

      # Step 8: Push Docker image
      - name: Push Docker image to Artifact Registry
        run: |
          echo "Pushing image: ${{ env.IMAGE_TAG }}"
          docker push ${{ env.IMAGE_TAG }}

          echo "Pushing latest tag: ${{ env.LATEST_TAG }}"
          docker push ${{ env.LATEST_TAG }}

      # Step 9: Prepare environment variables
      - name: Prepare environment variables
        run: |
          # Create env vars YAML file (avoids escaping issues with URLs)
          cat > /tmp/env-vars.yaml << 'ENVEOF'
          ENVIRONMENT: "production"
          FIREBASE_DATABASE_URL: "${{ secrets.FIREBASE_DATABASE_URL }}"
          FIREBASE_STORAGE_BUCKET: "${{ secrets.FIREBASE_STORAGE_BUCKET }}"
          ALLOWED_ORIGINS: "${{ secrets.ALLOWED_ORIGINS }}"
          OPENAI_API_KEY: "${{ secrets.OPENAI_API_KEY }}"
          GOOGLE_WEB_CLIENT_ID: "${{ secrets.GOOGLE_WEB_CLIENT_ID }}"
          GOOGLE_IOS_CLIENT_ID: "${{ secrets.GOOGLE_IOS_CLIENT_ID }}"
          GOOGLE_ANDROID_CLIENT_ID: "${{ secrets.GOOGLE_ANDROID_CLIENT_ID }}"
          STRIPE_SECRET_KEY: "${{ secrets.STRIPE_SECRET_KEY }}"
          STRIPE_WEBHOOK_SECRET: "${{ secrets.STRIPE_WEBHOOK_SECRET }}"
          STRIPE_PRO_PRICE_ID: "${{ secrets.STRIPE_PRO_PRICE_ID }}"
          APP_URL: "${{ secrets.APP_URL }}"
          JWT_SECRET: "${{ secrets.JWT_SECRET }}"
          ENCRYPTION_KEY: "${{ secrets.ENCRYPTION_KEY }}"
          ENVEOF

          echo "âœ… Environment variables prepared for production"
          echo ""
          echo "Environment variables (secrets redacted):"
          cat /tmp/env-vars.yaml | grep -v "SECRET\|KEY\|ENCRYPTION"

      # Step 10: Deploy to Cloud Run
      - name: Deploy to Cloud Run
        id: deploy
        run: |
          SERVICE_NAME="ishkul-backend"

          echo "Deploying ${SERVICE_NAME} to Cloud Run..."
          echo "Region: ${{ env.GCP_REGION }}"
          echo "Image: ${{ env.IMAGE_TAG }}"

          # Format version label (replace dots with dashes for GCP compliance)
          VERSION_LABEL=$(echo "${{ github.ref_name }}" | tr '.' '-')

          gcloud run deploy ${SERVICE_NAME} \
            --image=${{ env.IMAGE_TAG }} \
            --region=${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --env-vars-file=/tmp/env-vars.yaml \
            --min-instances=1 \
            --max-instances=100 \
            --memory='1Gi' \
            --cpu=2 \
            --timeout=300 \
            --labels="environment=production,version=${VERSION_LABEL}"

          # Get the service URL
          SERVICE_URL=$(gcloud run services describe ${SERVICE_NAME} \
            --region=${{ env.GCP_REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --format='value(status.url)')

          echo "service_url=${SERVICE_URL}" >> $GITHUB_OUTPUT
          echo "âœ… Backend deployed to Cloud Run"

      # Step 11: Verify deployment
      - name: Verify deployment
        run: |
          echo "Checking health endpoint..."
          sleep 5  # Give it a moment to start

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.deploy.outputs.service_url }}/health" || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Health check passed!"
          else
            echo "âš ï¸ Health check returned: $HTTP_CODE (may need warm-up time)"
          fi

      # Step 12: Release summary
      - name: Create release summary
        run: |
          echo "## ðŸš€ Production Release Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployments" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Backend** deployed to Cloud Run" >> $GITHUB_STEP_SUMMARY
          echo "  - URL: \`${{ steps.deploy.outputs.service_url }}\`" >> $GITHUB_STEP_SUMMARY
          echo "  - Image: \`${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "  - Latest tag: \`latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Frontend** will deploy via Vercel" >> $GITHUB_STEP_SUMMARY
          echo "  - Triggered by \`prod\` branch update" >> $GITHUB_STEP_SUMMARY
          echo "  - URL: https://ishkul.org" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Stripe Mode**: âœ… Live" >> $GITHUB_STEP_SUMMARY
          echo "- **Min Instances**: 1" >> $GITHUB_STEP_SUMMARY
          echo "- **Max Instances**: 100" >> $GITHUB_STEP_SUMMARY
          echo "- **Memory**: 1Gi" >> $GITHUB_STEP_SUMMARY
          echo "- **CPU**: 2" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What's Next" >> $GITHUB_STEP_SUMMARY
          echo "1. Vercel will auto-deploy frontend (monitor at https://vercel.com/mesbahtanvir/ishkul)" >> $GITHUB_STEP_SUMMARY
          echo "2. Both services live in ~10 minutes" >> $GITHUB_STEP_SUMMARY
          echo "3. Check status: https://github.com/mesbahtanvir/ishkul/actions" >> $GITHUB_STEP_SUMMARY
