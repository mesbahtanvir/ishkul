name: Deploy Backend to Staging

# STAGING DEPLOYMENT
# Triggered on pushes to main branch
# Uses the reusable workflow for consistent deployment architecture

on:
  push:
    branches: [main, master]
    paths:
      - 'backend/**'
      - 'prompts/**'
      - 'cloudbuild.yaml'
      - '.dockerignore'
      - '.github/workflows/deploy-backend-staging.yml'
      - '.github/workflows/deploy-backend-reusable.yml'
  workflow_dispatch:  # Allow manual trigger

# Only one staging deployment at a time
# New pushes cancel in-progress deployments
concurrency:
  group: staging-deploy
  cancel-in-progress: true

jobs:
  prepare:
    name: Prepare Staging Config
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.config.outputs.image_tag }}

    steps:
      - name: Generate configuration
        id: config
        run: |
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA="${SHORT_SHA:0:7}"
          echo "image_tag=staging-${SHORT_SHA}" >> $GITHUB_OUTPUT

  deploy:
    name: Deploy Staging
    needs: prepare
    uses: ./.github/workflows/deploy-backend-reusable.yml
    with:
      environment: staging
      service_name: ishkul-backend-staging
      image_tag: ${{ needs.prepare.outputs.image_tag }}
      # No collection_prefix - staging uses a separate Firebase project
      min_instances: 0
      max_instances: 10
      memory: '512Mi'
      cpu: 1
      stripe_mode: 'test'
    secrets:
      # Staging uses separate GCP/Firebase project
      GCP_PROJECT_ID: ${{ secrets.STAGING_GCP_PROJECT_ID }}
      GCP_SA_KEY: ${{ secrets.STAGING_GCP_SA_KEY }}
      FIREBASE_DATABASE_URL: ${{ secrets.STAGING_FIREBASE_DATABASE_URL }}
      FIREBASE_STORAGE_BUCKET: ${{ secrets.STAGING_FIREBASE_STORAGE_BUCKET }}
      # Use staging OpenAI key if set, otherwise fall back to shared key
      OPENAI_API_KEY: ${{ secrets.STAGING_OPENAI_API_KEY || secrets.OPENAI_API_KEY }}
      # Staging uses separate Google OAuth credentials
      GOOGLE_WEB_CLIENT_ID: ${{ secrets.STAGING_GOOGLE_WEB_CLIENT_ID }}
      GOOGLE_IOS_CLIENT_ID: ${{ secrets.STAGING_GOOGLE_IOS_CLIENT_ID }}
      GOOGLE_ANDROID_CLIENT_ID: ${{ secrets.STAGING_GOOGLE_ANDROID_CLIENT_ID }}
      STRIPE_TEST_SECRET_KEY: ${{ secrets.STRIPE_TEST_SECRET_KEY }}
      STRIPE_TEST_WEBHOOK_SECRET: ${{ secrets.STRIPE_TEST_WEBHOOK_SECRET }}
      STRIPE_TEST_PRO_PRICE_ID: ${{ secrets.STRIPE_TEST_PRO_PRICE_ID }}
      APP_URL: ${{ secrets.STAGING_APP_URL }}
      # Security: Use staging-specific secrets for complete isolation
      JWT_SECRET: ${{ secrets.STAGING_JWT_SECRET || secrets.JWT_SECRET }}
      ENCRYPTION_KEY: ${{ secrets.STAGING_ENCRYPTION_KEY || secrets.ENCRYPTION_KEY }}

  summary:
    name: Deployment Summary
    needs: [prepare, deploy]
    runs-on: ubuntu-latest

    steps:
      - name: Post Summary
        run: |
          echo "## ðŸŽ­ Staging Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **URL** | ${{ needs.deploy.outputs.service_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Service** | \`ishkul-backend-staging\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Firebase** | Separate staging project |" >> $GITHUB_STEP_SUMMARY
          echo "| **Stripe** | ðŸ§ª Test Mode |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Environment Features" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Separate Firebase project (complete data isolation)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Separate Google OAuth credentials" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Stripe TEST mode (test cards accepted)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… OpenAI enabled for testing" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Can be used for QA before production release" >> $GITHUB_STEP_SUMMARY
