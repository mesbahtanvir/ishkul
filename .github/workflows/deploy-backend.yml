name: Deploy Backend to Production

# PRODUCTION DEPLOYMENT
# Only triggered on release tags (v*) or manual dispatch
# Uses GitHub Environment protection for approval workflow

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0, v2.1.3, etc.
  workflow_dispatch:  # Allow manual trigger for hotfixes
    inputs:
      confirm_production:
        description: 'Type "production" to confirm deployment'
        required: true
        type: string

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: northamerica-northeast2
  SERVICE_NAME: ishkul-backend
  IMAGE_NAME: ishkul-backend

jobs:
  # Validation job for manual dispatch
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Validate confirmation
        if: github.event.inputs.confirm_production != 'production'
        run: |
          echo "âŒ You must type 'production' to confirm deployment"
          exit 1

  build-and-deploy:
    name: Build and Deploy to Production
    runs-on: ubuntu-latest
    needs: [validate]
    if: always() && (needs.validate.result == 'success' || needs.validate.result == 'skipped')

    # Use GitHub Environment for protection rules
    # Configure in: Settings > Environments > production
    # - Add required reviewers
    # - Restrict to protected branches/tags
    environment:
      name: production
      url: https://ishkul-backend-${{ secrets.GCP_PROJECT_NUMBER }}.${{ env.GCP_REGION }}.run.app

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="manual-${{ github.sha }}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Deploying version: ${VERSION}"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCP Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Build Docker image
        run: |
          REGISTRY="${{ env.GCP_REGION }}-docker.pkg.dev"
          VERSION="${{ steps.version.outputs.version }}"

          IMAGE_TAG="${REGISTRY}/${{ env.GCP_PROJECT_ID }}/cloud-run-source-deploy/${{ env.IMAGE_NAME }}:${VERSION}"
          LATEST_TAG="${REGISTRY}/${{ env.GCP_PROJECT_ID }}/cloud-run-source-deploy/${{ env.IMAGE_NAME }}:latest"

          echo "Building image: $IMAGE_TAG"
          docker build -t "$IMAGE_TAG" -t "$LATEST_TAG" -f backend/Dockerfile .

          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV

      - name: Push Docker image to Artifact Registry
        run: |
          docker push ${{ env.IMAGE_TAG }}
          docker push ${{ env.LATEST_TAG }}

      - name: Prepare environment variables
        run: |
          # Create env vars YAML file (avoids escaping issues with URLs)
          cat > /tmp/env-vars.yaml << 'ENVEOF'
          ENVIRONMENT: production
          FIREBASE_DATABASE_URL: "${{ secrets.FIREBASE_DATABASE_URL }}"
          FIREBASE_STORAGE_BUCKET: "${{ secrets.FIREBASE_STORAGE_BUCKET }}"
          ENVEOF

          # Add optional secrets
          if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "OPENAI_API_KEY: \"${{ secrets.OPENAI_API_KEY }}\"" >> /tmp/env-vars.yaml
          fi
          if [ -n "${{ secrets.GOOGLE_WEB_CLIENT_ID }}" ]; then
            echo "GOOGLE_WEB_CLIENT_ID: \"${{ secrets.GOOGLE_WEB_CLIENT_ID }}\"" >> /tmp/env-vars.yaml
          fi
          if [ -n "${{ secrets.GOOGLE_IOS_CLIENT_ID }}" ]; then
            echo "GOOGLE_IOS_CLIENT_ID: \"${{ secrets.GOOGLE_IOS_CLIENT_ID }}\"" >> /tmp/env-vars.yaml
          fi
          if [ -n "${{ secrets.GOOGLE_ANDROID_CLIENT_ID }}" ]; then
            echo "GOOGLE_ANDROID_CLIENT_ID: \"${{ secrets.GOOGLE_ANDROID_CLIENT_ID }}\"" >> /tmp/env-vars.yaml
          fi
          if [ -n "${{ secrets.ALLOWED_ORIGINS }}" ]; then
            echo "ALLOWED_ORIGINS: \"${{ secrets.ALLOWED_ORIGINS }}\"" >> /tmp/env-vars.yaml
          fi

          # Stripe integration
          if [ -n "${{ secrets.STRIPE_SECRET_KEY }}" ]; then
            echo "STRIPE_SECRET_KEY: \"${{ secrets.STRIPE_SECRET_KEY }}\"" >> /tmp/env-vars.yaml
          fi
          if [ -n "${{ secrets.STRIPE_PRO_PRICE_ID }}" ]; then
            echo "STRIPE_PRO_PRICE_ID: \"${{ secrets.STRIPE_PRO_PRICE_ID }}\"" >> /tmp/env-vars.yaml
          fi
          if [ -n "${{ secrets.STRIPE_WEBHOOK_SECRET }}" ]; then
            echo "STRIPE_WEBHOOK_SECRET: \"${{ secrets.STRIPE_WEBHOOK_SECRET }}\"" >> /tmp/env-vars.yaml
          fi
          if [ -n "${{ secrets.APP_URL }}" ]; then
            echo "APP_URL: \"${{ secrets.APP_URL }}\"" >> /tmp/env-vars.yaml
          fi

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image=${{ env.IMAGE_TAG }} \
            --region=${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --project=${{ env.GCP_PROJECT_ID }} \
            --env-vars-file=/tmp/env-vars.yaml \
            --min-instances=1 \
            --max-instances=100 \
            --memory=1Gi \
            --cpu=2 \
            --timeout=300

      - name: Verify deployment
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.GCP_REGION }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --format='value(status.url)')

          echo "service_url=${SERVICE_URL}" >> $GITHUB_OUTPUT

          # Health check
          echo "Checking health endpoint..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${SERVICE_URL}/health" || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Health check passed!"
          else
            echo "âš ï¸ Health check returned: $HTTP_CODE (may need warm-up time)"
          fi

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | ${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Service** | ${{ env.SERVICE_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Region** | ${{ env.GCP_REGION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Image** | ${{ env.IMAGE_TAG }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
