name: Deploy Backend
run-name: "ðŸš€ Backend Deploy â†’ ${{ github.ref_name == 'main' && 'staging' || startsWith(github.ref, 'refs/tags/v') && 'production' || github.event.inputs.environment || 'staging' }}"

# Backend deployment workflow
# - Push to main (with backend changes): deploys to staging
# - Tag v*: deploys to production
# - Manual dispatch: choose environment

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'Dockerfile'
      - '.github/workflows/deploy-backend.yml'
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      skip_ci_check:
        description: 'Skip CI status check (emergency deployments only)'
        required: false
        default: false
        type: boolean

# Cancel in-progress deployments for the same environment
concurrency:
  group: deploy-backend-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel deployments mid-flight

permissions:
  contents: write
  actions: read  # Required to check CI status

env:
  GCP_REGION: northamerica-northeast2
  IMAGE_NAME: ishkul-backend

jobs:
  # Check CI status before deploying (skip for tags or manual skip)
  check-ci:
    name: âœ… Verify CI Passed
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'push' &&
      !startsWith(github.ref, 'refs/tags/') &&
      github.event.inputs.skip_ci_check != 'true'
    steps:
      - name: Wait for CI to complete
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.sha }}
          running-workflow-name: 'CI'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10
          allowed-conclusions: success,skipped
          # Ignore this workflow itself to avoid circular dependency
          ignore-checks: 'âœ… Verify CI Passed,ðŸš€ Deploy to staging,ðŸš€ Deploy to production,ðŸ”§ Determine Environment'

  setup:
    name: ðŸ”§ Determine Environment
    runs-on: ubuntu-latest
    needs: [check-ci]
    if: always() && (needs.check-ci.result == 'success' || needs.check-ci.result == 'skipped')
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      service_name: ${{ steps.set-env.outputs.service_name }}
      image_tag: ${{ steps.set-env.outputs.image_tag }}
      previous_revision: ${{ steps.set-env.outputs.previous_revision }}
    steps:
      - name: Determine environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENV="${{ inputs.environment }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            ENV="production"
          else
            ENV="staging"
          fi
          echo "environment=${ENV}" >> $GITHUB_OUTPUT

          if [ "${ENV}" = "production" ]; then
            echo "service_name=ishkul-backend" >> $GITHUB_OUTPUT
            echo "image_tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            SHORT_SHA="${{ github.sha }}"
            echo "service_name=ishkul-backend-staging" >> $GITHUB_OUTPUT
            echo "image_tag=staging-${SHORT_SHA:0:7}" >> $GITHUB_OUTPUT
          fi

  deploy:
    name: ðŸš€ Deploy to ${{ needs.setup.outputs.environment }}
    needs: setup
    runs-on: ubuntu-latest
    environment: ${{ needs.setup.outputs.environment }}
    outputs:
      service_url: ${{ steps.deploy.outputs.service_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate release (production only)
        if: needs.setup.outputs.environment == 'production' && startsWith(github.ref, 'refs/tags/v')
        run: |
          VERSION="${{ github.ref_name }}"
          COMMIT="${{ github.sha }}"
          echo "Release: ${VERSION}"
          echo "Commit: ${COMMIT}"

      - name: Update prod branch (production only)
        if: needs.setup.outputs.environment == 'production' && startsWith(github.ref, 'refs/tags/v')
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git push origin ${{ github.sha }}:refs/heads/prod --force
          echo "Prod branch updated - Vercel will deploy frontend"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Get current revision for rollback
        id: current-revision
        run: |
          SERVICE="${{ needs.setup.outputs.service_name }}"
          # Get current serving revision (if service exists)
          CURRENT_REVISION=$(gcloud run revisions list \
            --service=${SERVICE} \
            --region=${{ env.GCP_REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --filter="status.conditions.type=Active AND status.conditions.status=True" \
            --format="value(metadata.name)" \
            --limit=1 2>/dev/null || echo "")

          if [ -n "$CURRENT_REVISION" ]; then
            echo "previous_revision=${CURRENT_REVISION}" >> $GITHUB_OUTPUT
            echo "Current revision: ${CURRENT_REVISION}"
          else
            echo "previous_revision=" >> $GITHUB_OUTPUT
            echo "No previous revision found (new service)"
          fi

      - name: Build Docker image
        run: |
          REGISTRY="${{ env.GCP_REGION }}-docker.pkg.dev"
          IMAGE_TAG="${REGISTRY}/${{ secrets.GCP_PROJECT_ID }}/cloud-run-source-deploy/${{ env.IMAGE_NAME }}:${{ needs.setup.outputs.image_tag }}"
          docker build -t "$IMAGE_TAG" -f backend/Dockerfile .
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

          # Also tag as latest for production
          if [ "${{ needs.setup.outputs.environment }}" = "production" ]; then
            LATEST_TAG="${REGISTRY}/${{ secrets.GCP_PROJECT_ID }}/cloud-run-source-deploy/${{ env.IMAGE_NAME }}:latest"
            docker tag "$IMAGE_TAG" "$LATEST_TAG"
            echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV
          fi

      - name: Push Docker image
        run: |
          docker push ${{ env.IMAGE_TAG }}
          if [ -n "${{ env.LATEST_TAG }}" ]; then
            docker push ${{ env.LATEST_TAG }}
          fi

      - name: Prepare environment variables
        run: |
          ENV="${{ needs.setup.outputs.environment }}"

          cat > /tmp/env-vars.yaml << EOF
          ENVIRONMENT: "${ENV}"
          FIREBASE_DATABASE_URL: "${{ secrets.FIREBASE_DATABASE_URL }}"
          FIREBASE_STORAGE_BUCKET: "${{ secrets.FIREBASE_STORAGE_BUCKET }}"
          EOF

          # Staging-specific
          if [ "${ENV}" = "staging" ]; then
            echo 'ALLOWED_ORIGINS: "http://localhost:3000,http://localhost:8081,https://staging.ishkul.org,https://ishkul.vercel.app,https://ishkul-*.vercel.app"' >> /tmp/env-vars.yaml
          fi

          # Production-specific (from secrets)
          if [ "${ENV}" = "production" ] && [ -n "${{ secrets.ALLOWED_ORIGINS }}" ]; then
            echo "ALLOWED_ORIGINS: \"${{ secrets.ALLOWED_ORIGINS }}\"" >> /tmp/env-vars.yaml
          fi

          # LLM Provider configuration
          [ -n "${{ secrets.LLM_PROVIDER }}" ] && echo "LLM_PROVIDER: \"${{ secrets.LLM_PROVIDER }}\"" >> /tmp/env-vars.yaml
          [ -n "${{ secrets.LLM_STRATEGY }}" ] && echo "LLM_STRATEGY: \"${{ secrets.LLM_STRATEGY }}\"" >> /tmp/env-vars.yaml
          [ -n "${{ secrets.OPENAI_API_KEY }}" ] && echo "OPENAI_API_KEY: \"${{ secrets.OPENAI_API_KEY }}\"" >> /tmp/env-vars.yaml
          [ -n "${{ secrets.DEEPSEEK_API_KEY }}" ] && echo "DEEPSEEK_API_KEY: \"${{ secrets.DEEPSEEK_API_KEY }}\"" >> /tmp/env-vars.yaml

          # Common optional secrets
          [ -n "${{ secrets.GOOGLE_WEB_CLIENT_ID }}" ] && echo "GOOGLE_WEB_CLIENT_ID: \"${{ secrets.GOOGLE_WEB_CLIENT_ID }}\"" >> /tmp/env-vars.yaml
          [ -n "${{ secrets.STRIPE_SECRET_KEY }}" ] && echo "STRIPE_SECRET_KEY: \"${{ secrets.STRIPE_SECRET_KEY }}\"" >> /tmp/env-vars.yaml
          [ -n "${{ secrets.STRIPE_WEBHOOK_SECRET }}" ] && echo "STRIPE_WEBHOOK_SECRET: \"${{ secrets.STRIPE_WEBHOOK_SECRET }}\"" >> /tmp/env-vars.yaml
          [ -n "${{ secrets.STRIPE_PRO_PRICE_ID }}" ] && echo "STRIPE_PRO_PRICE_ID: \"${{ secrets.STRIPE_PRO_PRICE_ID }}\"" >> /tmp/env-vars.yaml
          [ -n "${{ secrets.APP_URL }}" ] && echo "APP_URL: \"${{ secrets.APP_URL }}\"" >> /tmp/env-vars.yaml
          [ -n "${{ secrets.JWT_SECRET }}" ] && echo "JWT_SECRET: \"${{ secrets.JWT_SECRET }}\"" >> /tmp/env-vars.yaml
          [ -n "${{ secrets.ENCRYPTION_KEY }}" ] && echo "ENCRYPTION_KEY: \"${{ secrets.ENCRYPTION_KEY }}\"" >> /tmp/env-vars.yaml

      - name: Deploy to Cloud Run
        id: deploy
        run: |
          ENV="${{ needs.setup.outputs.environment }}"
          SERVICE="${{ needs.setup.outputs.service_name }}"

          # Environment-specific scaling
          if [ "${ENV}" = "production" ]; then
            MIN_INSTANCES=1
            MAX_INSTANCES=100
            MEMORY=1Gi
            CPU=2
          else
            MIN_INSTANCES=0
            MAX_INSTANCES=10
            MEMORY=512Mi
            CPU=1
          fi

          VERSION_LABEL=$(echo "${{ needs.setup.outputs.image_tag }}" | tr '.' '-')

          gcloud run deploy ${SERVICE} \
            --image=${{ env.IMAGE_TAG }} \
            --region=${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --env-vars-file=/tmp/env-vars.yaml \
            --min-instances=${MIN_INSTANCES} \
            --max-instances=${MAX_INSTANCES} \
            --memory=${MEMORY} \
            --cpu=${CPU} \
            --timeout=300 \
            --labels="environment=${ENV},version=${VERSION_LABEL}"

          SERVICE_URL=$(gcloud run services describe ${SERVICE} \
            --region=${{ env.GCP_REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --format='value(status.url)')
          echo "service_url=${SERVICE_URL}" >> $GITHUB_OUTPUT

      - name: Verify deployment
        id: health-check
        run: |
          SERVICE_URL="${{ steps.deploy.outputs.service_url }}"
          MAX_RETRIES=5
          RETRY_DELAY=10

          echo "Waiting for service to be ready..."
          sleep 5

          for i in $(seq 1 $MAX_RETRIES); do
            echo "Health check attempt $i of $MAX_RETRIES..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${SERVICE_URL}/health" || echo "000")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Health check passed!"
              echo "health_status=success" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "Health check returned: $HTTP_CODE"
              if [ $i -lt $MAX_RETRIES ]; then
                echo "Retrying in ${RETRY_DELAY}s..."
                sleep $RETRY_DELAY
              fi
            fi
          done

          echo "âŒ Health check failed after $MAX_RETRIES attempts"
          echo "health_status=failed" >> $GITHUB_OUTPUT
          exit 1

      - name: Rollback on failure
        if: failure() && steps.current-revision.outputs.previous_revision != ''
        run: |
          SERVICE="${{ needs.setup.outputs.service_name }}"
          PREVIOUS_REVISION="${{ steps.current-revision.outputs.previous_revision }}"

          echo "âš ï¸ Deployment failed! Rolling back to ${PREVIOUS_REVISION}..."

          gcloud run services update-traffic ${SERVICE} \
            --region=${{ env.GCP_REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --to-revisions=${PREVIOUS_REVISION}=100

          echo "âœ… Rollback complete. Traffic routed to ${PREVIOUS_REVISION}"

          # Verify rollback
          SERVICE_URL=$(gcloud run services describe ${SERVICE} \
            --region=${{ env.GCP_REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --format='value(status.url)')

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${SERVICE_URL}/health" || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Rollback verified - service is healthy"
          else
            echo "âš ï¸ Rollback completed but health check returned: $HTTP_CODE"
          fi

          echo "## âš ï¸ Deployment Rolled Back" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The deployment failed health checks and was automatically rolled back." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Rolled back to** | ${PREVIOUS_REVISION} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Failed image** | ${{ needs.setup.outputs.image_tag }} |" >> $GITHUB_STEP_SUMMARY

      - name: Deployment summary
        run: |
          ENV="${{ needs.setup.outputs.environment }}"
          echo "## ${ENV^} Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | ${ENV} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Service** | ${{ needs.setup.outputs.service_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **URL** | ${{ steps.deploy.outputs.service_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Image Tag** | ${{ needs.setup.outputs.image_tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY

          if [ "${ENV}" = "production" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Deployments" >> $GITHUB_STEP_SUMMARY
            echo "- Backend: Cloud Run (deployed)" >> $GITHUB_STEP_SUMMARY
            echo "- Frontend: Vercel (triggered via prod branch)" >> $GITHUB_STEP_SUMMARY
          fi
