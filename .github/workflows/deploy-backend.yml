name: Deploy Backend to Production

# PRODUCTION DEPLOYMENT
# Triggered when prod branch is updated (via release.yml workflow)
# Uses the reusable workflow for consistent deployment architecture

on:
  push:
    branches: [prod]
  workflow_dispatch:  # Allow manual trigger for hotfixes
    inputs:
      confirm_production:
        description: 'Type "production" to confirm deployment'
        required: true
        type: string

# Only one production deployment at a time
concurrency:
  group: production-deploy
  cancel-in-progress: false

jobs:
  # Validation job for manual dispatch
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Validate confirmation
        if: github.event.inputs.confirm_production != 'production'
        run: |
          echo "âŒ You must type 'production' to confirm deployment"
          exit 1

  prepare:
    name: Prepare Production Config
    runs-on: ubuntu-latest
    needs: [validate]
    if: always() && (needs.validate.result == 'success' || needs.validate.result == 'skipped')
    outputs:
      version: ${{ steps.config.outputs.version }}
      image_tag: ${{ steps.config.outputs.image_tag }}

    steps:
      - name: Checkout to get tags
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate configuration
        id: config
        run: |
          # Try to get version from tag pointing to this commit
          VERSION=$(git describe --tags --exact-match 2>/dev/null || echo "")
          if [ -z "$VERSION" ]; then
            SHORT_SHA="${{ github.sha }}"
            VERSION="prod-${SHORT_SHA:0:7}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "image_tag=${VERSION}" >> $GITHUB_OUTPUT
          echo "Deploying version: ${VERSION}"

  # Environment protection job
  # This job checks the production environment and gates the deployment
  check-environment:
    name: Check Production Environment
    runs-on: ubuntu-latest
    needs: prepare
    environment: production
    outputs:
      approved: 'true'

  deploy:
    name: Deploy Production
    needs: [prepare, check-environment]
    uses: ./.github/workflows/deploy-backend-reusable.yml

    # Use GitHub Environment for protection rules
    # Configure in: Settings > Environments > production
    # - Add required reviewers
    # - Restrict to protected branches/tags

    with:
      environment: production
      service_name: ishkul-backend
      image_tag: ${{ needs.prepare.outputs.image_tag }}
      collection_prefix: ''  # No prefix for production
      min_instances: 1
      max_instances: 100
      memory: '1Gi'
      cpu: 2
      stripe_mode: 'live'
      also_tag_latest: true
    secrets:
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      FIREBASE_DATABASE_URL: ${{ secrets.FIREBASE_DATABASE_URL }}
      FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GOOGLE_WEB_CLIENT_ID: ${{ secrets.GOOGLE_WEB_CLIENT_ID }}
      GOOGLE_IOS_CLIENT_ID: ${{ secrets.GOOGLE_IOS_CLIENT_ID }}
      GOOGLE_ANDROID_CLIENT_ID: ${{ secrets.GOOGLE_ANDROID_CLIENT_ID }}
      ALLOWED_ORIGINS: ${{ secrets.ALLOWED_ORIGINS }}
      STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
      STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
      STRIPE_PRO_PRICE_ID: ${{ secrets.STRIPE_PRO_PRICE_ID }}
      APP_URL: ${{ secrets.APP_URL }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}

  summary:
    name: Deployment Summary
    needs: [prepare, deploy]
    runs-on: ubuntu-latest

    steps:
      - name: Post Summary
        run: |
          echo "## ðŸš€ Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **URL** | ${{ needs.deploy.outputs.service_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | \`${{ needs.prepare.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Service** | \`ishkul-backend\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Stripe** | âœ… Live Mode |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Production Environment" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Production Firestore (no prefix)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Stripe LIVE mode (real payments)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Always-on (min 1 instance)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… High resources (2 CPU, 1Gi RAM)" >> $GITHUB_STEP_SUMMARY
