name: Staging E2E Tests

on:
  # Run on staging deployments
  deployment_status:

  # Manual trigger
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - preview

  # Run on PRs to main (against preview deployments)
  pull_request:
    branches: [main, master]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - 'e2e/**'
      - '.maestro/**'
      - 'tests/**'

env:
  STAGING_API_URL: https://ishkul-backend-staging-1086267507068.northamerica-northeast1.run.app
  STAGING_WEB_URL: https://ishkul-staging.vercel.app

jobs:
  # API Smoke Tests with Newman
  api-smoke-tests:
    name: API Smoke Tests
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'pull_request' ||
      (github.event_name == 'deployment_status' && github.event.deployment_status.state == 'success')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Newman
        uses: ./.github/actions/setup-newman
        with:
          with-reporters: 'true'

      - name: Get Test Auth Token
        id: auth
        run: |
          # Login with test account credentials to get auth token
          if [ -n "${{ secrets.TEST_USER_EMAIL }}" ] && [ -n "${{ secrets.TEST_USER_PASSWORD }}" ]; then
            echo "Logging in with test account credentials"
            RESPONSE=$(curl -s -X POST "${{ env.STAGING_API_URL }}/api/auth/login" \
              -H "Content-Type: application/json" \
              -d "{\"email\": \"${{ secrets.TEST_USER_EMAIL }}\", \"password\": \"${{ secrets.TEST_USER_PASSWORD }}\"}")
            TOKEN=$(echo $RESPONSE | jq -r '.token // empty')
            if [ -n "$TOKEN" ] && [ "$TOKEN" != "null" ]; then
              echo "token=$TOKEN" >> $GITHUB_OUTPUT
              echo "Successfully obtained auth token"
            else
              echo "Warning: Could not obtain auth token from login"
              echo "token=" >> $GITHUB_OUTPUT
            fi
          else
            echo "No test credentials available - running unauthenticated tests only"
            echo "token=" >> $GITHUB_OUTPUT
          fi

      - name: Run API Tests
        run: |
          newman run tests/postman/ishkul-api.collection.json \
            -e tests/postman/staging.environment.json \
            --env-var "authToken=${{ steps.auth.outputs.token }}" \
            --reporters cli,junit,htmlextra \
            --reporter-junit-export tests/postman/results/junit.xml \
            --reporter-htmlextra-export tests/postman/results/report.html
        continue-on-error: true

      - name: Upload API Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-test-results
          path: tests/postman/results/
          retention-days: 14

      - name: Publish Test Results
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
          report_paths: 'tests/postman/results/junit.xml'
          check_name: 'API Tests'

  # Playwright Web E2E Tests
  web-e2e-tests:
    name: Web E2E Tests
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'pull_request' ||
      (github.event_name == 'deployment_status' && github.event.deployment_status.state == 'success')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install E2E dependencies
        run: |
          cd e2e
          npm ci
          npx playwright install --with-deps chromium

      - name: Get Test Auth Token
        id: auth
        run: |
          # Login with test account credentials to get auth token
          if [ -n "${{ secrets.TEST_USER_EMAIL }}" ] && [ -n "${{ secrets.TEST_USER_PASSWORD }}" ]; then
            echo "Logging in with test account credentials"
            RESPONSE=$(curl -s -X POST "${{ env.STAGING_API_URL }}/api/auth/login" \
              -H "Content-Type: application/json" \
              -d "{\"email\": \"${{ secrets.TEST_USER_EMAIL }}\", \"password\": \"${{ secrets.TEST_USER_PASSWORD }}\"}")
            TOKEN=$(echo $RESPONSE | jq -r '.token // empty')
            if [ -n "$TOKEN" ] && [ "$TOKEN" != "null" ]; then
              echo "token=$TOKEN" >> $GITHUB_OUTPUT
              echo "Successfully obtained auth token"
            else
              echo "Warning: Could not obtain auth token from login"
              echo "token=" >> $GITHUB_OUTPUT
            fi
          else
            echo "No test credentials available - running unauthenticated tests only"
            echo "token=" >> $GITHUB_OUTPUT
          fi

      - name: Run Playwright Tests
        run: |
          cd e2e
          npx playwright test --project=chromium
        env:
          STAGING_URL: ${{ env.STAGING_WEB_URL }}
          TEST_AUTH_TOKEN: ${{ steps.auth.outputs.token }}
          CI: true
        continue-on-error: true

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: e2e/playwright-report/
          retention-days: 14

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-results
          path: e2e/test-results/
          retention-days: 14

  # k6 Smoke Test
  api-performance-smoke:
    name: API Performance Smoke Test
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'deployment_status' && github.event.deployment_status.state == 'success')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup k6
        uses: ./.github/actions/setup-k6

      - name: Run k6 Smoke Test
        run: |
          mkdir -p tests/k6/results
          k6 run tests/k6/smoke-test.js --env USE_STAGING=true
        env:
          STAGING_URL: ${{ env.STAGING_API_URL }}
        continue-on-error: true

      - name: Upload k6 Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: k6-smoke-results
          path: tests/k6/results/
          retention-days: 14

  # Summary job
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [api-smoke-tests, web-e2e-tests, api-performance-smoke]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "## E2E Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.api-smoke-tests.result }}" == "success" ]; then
            echo "✅ API Smoke Tests: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ API Smoke Tests: ${{ needs.api-smoke-tests.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.web-e2e-tests.result }}" == "success" ]; then
            echo "✅ Web E2E Tests: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Web E2E Tests: ${{ needs.web-e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.api-performance-smoke.result }}" == "success" ]; then
            echo "✅ API Performance: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ API Performance: ${{ needs.api-performance-smoke.result }}" >> $GITHUB_STEP_SUMMARY
          fi
